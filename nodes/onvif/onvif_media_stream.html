<!--
  Copyright 2025 Panther Computers

  Licensed under the Apache License, Version 2.0
-->

<script type="text/javascript">
RED.nodes.registerType('onvif-media-stream',{
    category: 'OnVif',
    color: '#ff758d',
    defaults: {
        name: { value:"" },
        deviceConfig: { value:"", type:"onvif-config", required:true },
        action: { value:"" },
        profileName: { value:"" },
        protocol: { value:"RTSP" },
        stream: { value:"RTP-Unicast" }
    },
    inputs:1,
    outputs:1,
    icon:"font-awesome/fa-film",
    label: function() {
        return this.name || "ONVIF Media Stream";
    },
    oneditprepare: function () {
        $(".actionParam-row").hide();

        $("#node-input-action").on("change", function () {
            $(".actionParam-row").hide();
            const a = $(this).val();

            if (a === "getStreamUri") {
                $("#profileName-row").show();
                $("#protocol-row").show();
                $("#stream-row").show();
            }

            if (a === "getSnapshotUri" || a === "getSnapshot") {
                $("#profileName-row").show();
            }
        });
    }
});
</script>

<script type="text/x-red" data-template-name="onvif-media-stream">
    <div class="form-row">
        <label><i class="fa fa-cog"></i> Device</label>
        <input type="text" id="node-input-deviceConfig">
    </div>

    <div class="form-row">
        <label><i class="fa fa-wrench"></i> Action</label>
        <select id="node-input-action">
            <option value="">— via msg.action —</option>
            <option value="getStreamUri">Get stream URI</option>
            <option value="getSnapshotUri">Get snapshot URI</option>
            <option value="reconnect">Reconnect</option>
        </select>
    </div>

    <div class="form-row actionParam-row" id="profileName-row">
        <label>Profile</label>
        <input type="text" id="node-input-profileName">
    </div>

    <div class="form-row actionParam-row" id="protocol-row">
        <label>Protocol</label>
        <select id="node-input-protocol">
            <option value="RTSP">RTSP</option>
            <option value="HTTP">HTTP</option>
            <option value="UDP">UDP</option>
        </select>
    </div>

    <div class="form-row actionParam-row" id="stream-row">
        <label>RTP Stream</label>
        <select id="node-input-stream">
            <option value="RTP-Unicast">Unicast</option>
            <option value="RTP-Multicast">Multicast</option>
        </select>
    </div>

    <hr>

    <div class="form-row">
        <label>Name</label>
        <input type="text" id="node-input-name">
    </div>
</script>

<script type="text/x-red" data-help-name="onvif-media-stream">
<p>
<strong>ONVIF Media Stream — Media URI Retrieval</strong>
</p>
<p>
<strong>Purpose</strong>
</p><p>
This node retrieves streaming or snapshot URIs for a selected media profile.
</p><p>
What it does
</p><p>
<ul><li>
Get Stream URI
</li><li>
Get Snapshot URI
</li><li>
Reconnect device
</li></ul>
</p><p>
What it does NOT do
</p><p>
<ul><li>
It does not open streams
</li><li>
It does not proxy video
</li></ul>
</p><p>
Profile requirement
</p><p>
A valid ProfileToken is required for all stream actions.
</p><p>
Status meanings
</p><p>
<ul><li>
connected – Media service available
</li><li>
unsupported – Media streaming not advertised
</li><li>
disconnected – Camera unreachable
</li></ul>
</p>
<hr>
<strong><center>Snapshots note:</center></strong>
</p>
<p>
This node follows the ONVIF specification and returns a snapshot URI only.
It does not download the image itself.
</p><p>
Most ONVIF cameras:
</p><p>
<ul>
    <li>Return internal IP addresses</li>
    <li>Always use port 80 or 443</li>
    <li>Are unaware of NAT or port forwarding</li>
</ul>
</p><p>
Because of this, additional flow logic is required.
</p>

<p>
To retrieve the actual image:
</p>

<ol>
  <li>Use <b>Get snapshot URI</b></li>
<li> Use a change node to change msg.payload.uri to msg.payload.url<br>
     or use a function node to craft the msg.payload.url needed by the HTTP Request node</li>
  <li>Connect to a <b>HTTP Request</b> node</li>
  <li>Enable <b>Digest Authentication</b></li>
  <li>Set <code>Return</code> to <b>a binary buffer</b></li>
</ol>

<p>
This separation ensures compatibility with all ONVIF cameras and avoids
authentication and transport issues.
</p>
<p><strong> This Node: </strong> </p>
<p>
Retrieves stream and snapshot information from an ONVIF camera.
</p>
<ul>
<li><b>Get stream URI</b> — returns RTSP/HTTP stream URL</li>
<li><b>Get snapshot URI</b> — returns snapshot endpoint</li>
</ul>
<p>
If no action is selected, <code>msg.action</code> must be provided.
</p>
</script>
