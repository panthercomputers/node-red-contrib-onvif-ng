<!--
  Original work:
  Copyright 2018 Bart Butenaers

  Modifications:
  Copyright 2025 Panther Computers

  Licensed under the Apache License, Version 2.0
-->
<script type="text/javascript">
RED.nodes.registerType('onvif-ptz',{
    category: 'OnVif',
    color: '#ff758d',
    defaults: {
        name: {value:""},
        deviceConfig: {value:"", type:"onvif-config", required:true},
        profileName: {value:""},
        action: {value:"", required:true},
        panSpeed: {value:0},
        tiltSpeed: {value:0},
        zoomSpeed: {value:0},
        panPosition: {value:0},
        tiltPosition: {value:0},
        zoomPosition: {value:0},
        panTranslation: {value:0},
        tiltTranslation: {value:0},
        zoomTranslation: {value:0},
        time: {value:1},
        preset: {value:""},
        presetName: {value:""},
        stopPanTilt: {value:true},
        stopZoom: {value:true},
        configurationToken: {value:""}
    },
    inputs:1,
    outputs:1,
    icon:"ptz.png",
    label: function() {
        return this.name || "ONVIF PTZ";
    },

    oneditprepare: function () {
        const toggleFields = () => {
            const action = $("#node-input-action").val();
            $(".actionParam-row").hide();

            const show = ids => ids.forEach(id => $("#"+id).show());

            switch (action) {
                case "continuousMove":
                    show(["profileName-div","panSpeed-div","tiltSpeed-div","zoomSpeed-div","time-div"]);
                    break;
                case "absoluteMove":
                    show([
                        "profileName-div",
                        "panSpeed-div","tiltSpeed-div","zoomSpeed-div",
                        "panPosition-div","tiltPosition-div","zoomPosition-div",
                        "time-div"
                    ]);
                    break;
                case "relativeMove":
                    show([
                        "profileName-div",
                        "panTranslation-div","tiltTranslation-div","zoomTranslation-div"
                    ]);
                    break;
                case "gotoPreset":
                    show(["profileName-div","preset-div","panSpeed-div","tiltSpeed-div","zoomSpeed-div"]);
                    break;
                case "setPreset":
                    show(["profileName-div","preset-div","presetName-div"]);
                    break;
                case "removePreset":
                case "getPresets":
                case "getStatus":
                case "gotoHomePosition":
                case "setHomePosition":
                    show(["profileName-div"]);
                    break;
                case "stop":
                    show(["profileName-div","stopPanTilt-div","stopZoom-div"]);
                    break;
                case "getConfigurationOptions":
                    show(["configurationToken-div"]);
                    break;
            }
        };

        $("#node-input-action").on("change", toggleFields);

        /* ---- Profile autocomplete ---- */
        try {
            $("#node-input-profileName").autocomplete("destroy");
        } catch(e) {}

        $("#node-input-profile-search").on("click", function () {
            const configId = $("#node-input-deviceConfig").val();
            if (!configId) return;

            const configNode = RED.nodes.node(configId);
            if (!configNode) return;

            const cfg = {
                hostname: configNode.xaddress,
                port: configNode.port,
                user: configNode.credentials?.user,
                password: configNode.credentials?.password
            };

            $.getJSON("onvifdevice/profiles/" + configId, cfg, function (profiles) {
                $("#node-input-profileName").autocomplete({
                    source: profiles,
                    minLength: 0,
                    select: function (e, ui) {
                        e.preventDefault();
                        $("#node-input-profileName").val(ui.item.label);
                    },
                    focus: function (e, ui) {
                        e.preventDefault();
                        $("#node-input-profileName").val(ui.item.label);
                    }
                }).autocomplete("search","");
            });
        });

        toggleFields();
    }
});
</script>

<script type="text/x-red" data-template-name="onvif-ptz">
    <div class="form-row">
        <label>Device</label>
        <input type="text" id="node-input-deviceConfig">
    </div>

    <div class="form-row">
        <label>Action</label>
        <select id="node-input-action">
            <option value=""></option>
            <option value="continuousMove">Continuous move</option>
            <option value="absoluteMove">Absolute move</option>
            <option value="relativeMove">Relative move</option>
            <option value="gotoHomePosition">Goto home</option>
            <option value="setHomePosition">Set home</option>
            <option value="getPresets">Get presets</option>
            <option value="setPreset">Set preset</option>
            <option value="gotoPreset">Goto preset</option>
            <option value="removePreset">Remove preset</option>
            <option value="getStatus">Get status</option>
            <option value="stop">Stop</option>
            <option value="reconnect">Reconnect</option>
        </select>
    </div>

    <div class="form-row actionParam-row" id="profileName-div">
        <label>Profile</label>
        <input type="text" id="node-input-profileName" style="width:65%">
        <a id="node-input-profile-search" class="btn"><i class="fa fa-search"></i></a>
    </div>

    <div class="form-row actionParam-row" id="panSpeed-div">
        <label>Pan speed</label>
        <input type="number" id="node-input-panSpeed" step="0.1" min="-1" max="1">
    </div>

    <div class="form-row actionParam-row" id="tiltSpeed-div">
        <label>Tilt speed</label>
        <input type="number" id="node-input-tiltSpeed" step="0.1" min="-1" max="1">
    </div>

    <div class="form-row actionParam-row" id="zoomSpeed-div">
        <label>Zoom speed</label>
        <input type="number" id="node-input-zoomSpeed" step="0.1">
    </div>

    <div class="form-row actionParam-row" id="panPosition-div">
        <label>Pan position</label>
        <input type="number" id="node-input-panPosition" step="0.1">
    </div>

    <div class="form-row actionParam-row" id="tiltPosition-div">
        <label>Tilt position</label>
        <input type="number" id="node-input-tiltPosition" step="0.1">
    </div>

    <div class="form-row actionParam-row" id="zoomPosition-div">
        <label>Zoom position</label>
        <input type="number" id="node-input-zoomPosition" step="0.1">
    </div>

    <div class="form-row actionParam-row" id="panTranslation-div">
        <label>Pan translation</label>
        <input type="number" id="node-input-panTranslation" step="0.1">
    </div>

    <div class="form-row actionParam-row" id="tiltTranslation-div">
        <label>Tilt translation</label>
        <input type="number" id="node-input-tiltTranslation" step="0.1">
    </div>

    <div class="form-row actionParam-row" id="zoomTranslation-div">
        <label>Zoom translation</label>
        <input type="number" id="node-input-zoomTranslation" step="0.1">
    </div>

    <div class="form-row actionParam-row" id="time-div">
        <label>Time (s)</label>
        <input type="number" id="node-input-time" min="0">
    </div>

    <div class="form-row actionParam-row" id="preset-div">
        <label>Preset</label>
        <input type="text" id="node-input-preset">
    </div>

    <div class="form-row actionParam-row" id="presetName-div">
        <label>Preset name</label>
        <input type="text" id="node-input-presetName">
    </div>

    <div class="form-row actionParam-row" id="configurationToken-div">
        <label>Config token</label>
        <input type="text" id="node-input-configurationToken">
    </div>

    <div class="form-row actionParam-row" id="stopPanTilt-div">
        <input type="checkbox" id="node-input-stopPanTilt">
        <label for="node-input-stopPanTilt">Stop pan/tilt</label>
    </div>

    <div class="form-row actionParam-row" id="stopZoom-div">
        <input type="checkbox" id="node-input-stopZoom">
        <label for="node-input-stopZoom">Stop zoom</label>
    </div>

    <hr>
    <div class="form-row">
        <label>Name</label>
        <input type="text" id="node-input-name">
    </div>
</script>

<script type="text/x-red" data-help-name="onvif-ptz">
<p>Control Pan, Tilt and Zoom functions of an ONVIF-compatible device.</p>
<p>This node requires a camera with ONVIF PTZ capability.
<p>Non-PTZ cameras will return an error.
  
</script>

