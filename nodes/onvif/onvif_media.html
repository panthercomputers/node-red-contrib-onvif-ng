<!--
  Original work:
  Copyright 2018 Bart Butenaers

  Modifications:
  Copyright 2025 Panther Computers

  Licensed under the Apache License, Version 2.0 (the "License");
-->
<script type="text/javascript">
RED.nodes.registerType('onvif-media', {
    category: 'ONVIF',
    color: '#ff758d',

    defaults: {
        name: { value: "" },
        deviceConfig: { value: "", type: "onvif-config", required: true },

        action: { value: "" },

        profileToken: { value: "" },
        profileName: { value: "" },

        videoEncoderConfigToken: { value: "" },
        videoEncoderConfigName: { value: "" },
        videoEncoderConfigEncoding: { value: "" },

        protocol: { value: "" },
        stream: { value: "RTP-Unicast" }
    },

    inputs: 1,
    outputs: 1,
    icon: "media.png",

    label: function () {
        return this.name || "ONVIF Media";
    },

    oneditprepare: function () {
        const node = this;

        $(".actionParam-row").hide();

        $("#node-input-action").on("change", function () {
            const action = $(this).val();
            $(".actionParam-row").hide();

            switch (action) {
                case "getStreamUri":
                    $("#profileName-row").show();
                    $("#protocol-row").show();
                    $("#stream-row").show();
                    break;

                case "getSnapshotUri":
                case "getSnapshot":
                case "deleteProfile":
                    $("#profileName-row").show();
                    break;

                case "getOSDs":
                case "getVideoEncoderConfiguration":
                case "getVideoEncoderConfigurationOptions":
                    $("#videoEncoderConfigToken-row").show();
                    break;

                case "createProfile":
                    $("#profileToken-row").show();
                    $("#profileName-row").show();
                    break;
            }
        });

        // Profile lookup
        $("#node-input-profileName-search").on("click", function () {
            const configNodeId = $("#node-input-deviceConfig").val();
            if (!configNodeId) {
                return;
            }

            const configNode = RED.nodes.node(configNodeId);
            if (!configNode) {
                return;
            }

            const configData = {
                hostname: configNode.xaddress
            };

            if (configNode.credentials) {
                configData.user = configNode.credentials.user;
                configData.password = configNode.credentials.password;
            }

            $(this).addClass("disabled");

            $.getJSON("onvifdevice/profiles/" + configNodeId, configData)
                .done(function (profiles) {
                    $("#node-input-profileName").autocomplete({
                        source: profiles,
                        minLength: 0,
                        select: function (event, ui) {
                            event.preventDefault();
                            $("#node-input-profileName").val(ui.item.label);
                        },
                        focus: function (event, ui) {
                            event.preventDefault();
                            $("#node-input-profileName").val(ui.item.label);
                        }
                    }).autocomplete("search", "");
                })
                .always(function () {
                    $("#node-input-profileName-search").removeClass("disabled");
                });
        });
    },

    oneditsave: function () {
        if ($("#node-input-action").val() === "") {
            $("#node-input-profileToken").val("");
            $("#node-input-profileName").val("");
            $("#node-input-videoEncoderConfigToken").val("");
            $("#node-input-videoEncoderConfigName").val("");
            $("#node-input-videoEncoderConfigEncoding").val("");
            $("#node-input-protocol").val("");
            $("#node-input-stream").val("");
        }
    }
});
</script>

<script type="text/x-red" data-template-name="onvif-media">
    <div class="form-row">
        <label for="node-input-deviceConfig">
            <i class="fa fa-cog"></i> Device
        </label>
        <input type="text" id="node-input-deviceConfig">
    </div>

    <div class="form-row">
        <label for="node-input-action">
            <i class="fa fa-wrench"></i> Action
        </label>
        <select id="node-input-action">
            <option value="">— set via msg.action —</option>
            <option value="getStreamUri">Get stream URI</option>
            <option value="getProfiles">Get profiles</option>
            <option value="getSnapshotUri">Get snapshot URI</option>
            <option value="getSnapshot">Get snapshot</option>
            <option value="getOSDs">Get OSDs</option>
            <option value="getVideoEncoderConfiguration">Get video encoder configuration</option>
            <option value="getVideoEncoderConfigurationOptions">Get video encoder configuration options</option>
            <option value="createProfile">Create profile</option>
            <option value="deleteProfile">Delete profile</option>
            <option value="reconnect">Reconnect</option>
        </select>
    </div>

    <div class="form-row actionParam-row" id="profileToken-row">
        <label for="node-input-profileToken">
            <i class="fa fa-hashtag"></i> Profile token
        </label>
        <input type="text" id="node-input-profileToken">
    </div>

    <div class="form-row actionParam-row" id="profileName-row">
        <label for="node-input-profileName">
            <i class="fa fa-random"></i> Profile
        </label>
        <input type="text" id="node-input-profileName" style="width:66%;">
        <a id="node-input-profileName-search" class="btn">
            <i class="fa fa-search"></i>
        </a>
    </div>

    <div class="form-row actionParam-row" id="videoEncoderConfigToken-row">
        <label for="node-input-videoEncoderConfigToken">
            <i class="fa fa-hashtag"></i> Config token
        </label>
        <input type="text" id="node-input-videoEncoderConfigToken">
    </div>

    <div class="form-row actionParam-row" id="protocol-row">
        <label for="node-input-protocol">
            <i class="fa fa-exchange-alt"></i> Protocol
        </label>
        <select id="node-input-protocol">
            <option value=""></option>
            <option value="HTTP">HTTP</option>
            <option value="UDP">UDP</option>
            <option value="RTSP">RTSP</option>
        </select>
    </div>

    <div class="form-row actionParam-row" id="stream-row">
        <label for="node-input-stream">
            <i class="fa fa-code-branch"></i> RTP stream
        </label>
        <select id="node-input-stream">
            <option value="RTP-Unicast">Unicast</option>
            <option value="RTP-Multicast">Multicast</option>
        </select>
    </div>

    <hr>

    <div class="form-row">
        <label for="node-input-name">
            <i class="fa fa-tag"></i> Name
        </label>
        <input type="text" id="node-input-name" placeholder="ONVIF Media">
    </div>
</script>

<script type="text/x-red" data-help-name="onvif-media">
    <p>
        <strong>ONVIF Media</strong>
    </p>
    <p>
        Executes media-related ONVIF operations such as retrieving stream URIs,
        profiles, snapshots, and encoder configuration details.
    </p>
    <p>
        If no action is selected, the action must be provided in
        <code>msg.action</code>.
    </p>
</script>
