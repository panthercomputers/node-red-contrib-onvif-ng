<!--
  Original work:
  Copyright 2018 Bart Butenaers

  Modifications:
  Copyright 2025 Panther Computers

  Licensed under the Apache License, Version 2.0
-->
<script type="text/javascript">
RED.nodes.registerType('onvif-media', {
    category: 'OnVif',
    color: '#ff758d',

    defaults: {
        name: { value: "" },
        deviceConfig: { value: "", type: "onvif-config", required: true },

        action: { value: "", required: true },

        profileToken: { value: "" },
        profileName: { value: "" },

        videoEncoderConfigToken: { value: "" },

        protocol: { value: "RTSP" },
        stream: { value: "RTP-Unicast" }
    },

    inputs: 1,
    outputs: 1,
    icon: "font-awesome/fa-thumbs-o-down",
    paletteLabel: "ONVIF Media (deprecated)",
    label: function () {
        return (this.name || "ONVIF Media") + " (deprecated)";
    },
    oneditprepare: function () {

        const toggleFields = () => {
            const action = $("#node-input-action").val();
            $(".actionParam-row").hide();

            switch (action) {
                case "getStreamUri":
                    $("#profileName-row").show();
                    $("#protocol-row").show();
                    $("#stream-row").show();
                    break;

                case "getSnapshotUri":
                case "getSnapshot":
                case "deleteProfile":
                    $("#profileName-row").show();
                    break;

                case "getOSDs":
                case "getVideoEncoderConfiguration":
                case "getVideoEncoderConfigurationOptions":
                    $("#videoEncoderConfigToken-row").show();
                    break;

                case "createProfile":
                    $("#profileToken-row").show();
                    $("#profileName-row").show();
                    break;
            }
        };

        $("#node-input-action").on("change", toggleFields);

        /* ---- Profile lookup ---- */
        try {
            $("#node-input-profileName").autocomplete("destroy");
        } catch(e) {}

        $("#node-input-profileName-search").on("click", function () {
            const configNodeId = $("#node-input-deviceConfig").val();
            if (!configNodeId) return;

            $.getJSON("onvifdevice/profiles/" + configNodeId, function (profiles) {
                $("#node-input-profileName").autocomplete({
                    source: profiles,
                    minLength: 0,
                    select: function (event, ui) {
                        event.preventDefault();
                        $("#node-input-profileName").val(ui.item.label);
                        $("#node-input-profileToken").val(ui.item.value);
                    },
                    focus: function (event, ui) {
                        event.preventDefault();
                        $("#node-input-profileName").val(ui.item.label);
                    }
                }).autocomplete("search", "");
            });
        });

        toggleFields();
    }
});
</script>

<script type="text/x-red" data-template-name="onvif-media">
    <div class="form-row">
        <label>Device</label>
        <input type="text" id="node-input-deviceConfig">
    </div>

    <div class="form-row">
        <label>Action</label>
        <select id="node-input-action">
            <option value=""></option>
            <option value="getStreamUri">Get stream URI</option>
            <option value="getProfiles">Get profiles</option>
            <option value="getSnapshotUri">Get snapshot URI</option>
            <option value="getSnapshot">Get snapshot</option>
            <option value="getOSDs">Get OSDs</option>
            <option value="getVideoEncoderConfiguration">Get video encoder configuration</option>
            <option value="getVideoEncoderConfigurationOptions">Get video encoder configuration options</option>
            <option value="createProfile">Create profile</option>
            <option value="deleteProfile">Delete profile</option>
            <option value="reconnect">Reconnect</option>
        </select>
    </div>

    <div class="form-row actionParam-row" id="profileToken-row">
        <label>Profile token</label>
        <input type="text" id="node-input-profileToken">
    </div>

    <div class="form-row actionParam-row" id="profileName-row">
        <label>Profile</label>
        <input type="text" id="node-input-profileName" style="width:65%">
        <a id="node-input-profileName-search" class="btn">
            <i class="fa fa-search"></i>
        </a>
    </div>

    <div class="form-row actionParam-row" id="videoEncoderConfigToken-row">
        <label>Encoder config token</label>
        <input type="text" id="node-input-videoEncoderConfigToken">
    </div>

    <div class="form-row actionParam-row" id="protocol-row">
        <label>Protocol</label>
        <select id="node-input-protocol">
            <option value="RTSP">RTSP</option>
            <option value="HTTP">HTTP</option>
            <option value="UDP">UDP</option>
        </select>
    </div>

    <div class="form-row actionParam-row" id="stream-row">
        <label>RTP stream</label>
        <select id="node-input-stream">
            <option value="RTP-Unicast">Unicast</option>
            <option value="RTP-Multicast">Multicast</option>
        </select>
    </div>

    <hr>

    <div class="form-row">
        <label>Name</label>
        <input type="text" id="node-input-name">
    </div>
</script>

<script type="text/x-red" data-help-name="onvif-media">
<p><b>âš  Deprecated</b></p>
<p>
This node is deprecated and will be removed in a future major release.
Use <b>ONVIF Media Stream</b> or <b>ONVIF Media Profile</b>.
</p>
<hr>
<p>Media-related ONVIF operations such as stream URI retrieval, snapshots, profiles, and encoder configuration.</p>
</script>
